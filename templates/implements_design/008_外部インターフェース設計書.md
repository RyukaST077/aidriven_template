# 外部インターフェース設計書

## 1. インターフェース一覧
| IF ID | 連携システム | 名称 | 方式 | プロトコル | 方向 | 頻度 | 備考 |
| -- | -- | -- | -- | -- | -- | -- | -- |
| IF001 | 決済代行システム | 決済API | REST API | HTTPS | Out | 都度 | |
| IF002 | 基幹システム | 売上データ連携 | ファイル転送 | SFTP | Out | 日次 | |

## 2. インターフェース詳細

### 2.0 OpenAPI仕様 (Swagger)
<!-- 本設計書はOpenAPI (v3.x) 形式での定義を正とします。詳細は以下のYAML/JSONを参照してください。 -->
* **Define File**: [`docs/openapi.yaml`](../openapi.yaml)
* **Viewer**: Swagger UI / Redoc

### 2.1 [IF001] 決済API
#### 2.1.1 概要
ユーザーが商品を注文した際に、即時決済を行うためのAPI。

#### 2.1.2 接続情報
* **Base URL**: `https://api.payment-gateway.com`
* **Auth**: Bearer Token (OAuth 2.0)
* **Timeout**: 
  - 接続タイムアウト: 5秒
  - 読み取りタイムアウト: 10秒
* **レート制限**: 100 req/min (変更時はサーキットブレーカーで対応)

#### 2.1.2a リトライポリシー
**リトライ対象**:
* 5xxエラー (サーバー障害)
* ネットワークタイムアウト
* 429 Too Many Requests (レート制限)

**リトライ設定**:
* 最大リトライ回数: 3回
* バックオフ戦略: 指数バックオフ (1秒 → 2秒 → 4秒)
* ジッター: ±20%のランダム遅延

**リトライ不可対象**:
* 4xxエラー (バリデーションエラー等)
* 401 Unauthorized (認証失敗)

#### 2.1.2b 冪等性設計
**二重送信防止**:
* **Idempotency Key**: リクエストヘッダーに `Idempotency-Key: {UUID}` を追加
* 同一キーで24時間以内の再送信は同じ結果を返す
* クライアント側でUUIDを生成・保持

**トランザクション管理**:
* 決済リクエスト前にローカルDBに `payment_transactions` レコード作成 (status: PENDING)
* 成功時: status → SUCCESS、失敗時: status → FAILED
* リトライ時は同一transaction_idを使用

#### 2.1.2c レート制限対応
**429 Too Many Requests 受信時**:
* `Retry-After` ヘッダーを確認し、指定秒数待機
* サーキットブレーカー: レート制限エラーが5分間に10回発生でOpen状態
* ローカルレートリミッター: 90 req/min（外部API制限の90%）

#### 2.1.3 インターフェース定義 (OpenAPI Structure)
**Operation**: `POST /v1/charges`
**Summary**: Create a charge

**Parameters / Request Body**:
| Name | In | Type | Required | Description |
| -- | -- | -- | -- | -- |
| Authorization | header | string | Yes | Bearer Token |
| amount | body | integer | Yes | 決済金額 |
| currency | body | string | Yes | 通貨コード (jpy) |
| source | body | string | Yes | トークンID |

**Responses**:
| Code | Description | Content-Type | Schema Ref |
| -- | -- | -- | -- |
| 200 | 決済成功 | application/json | `#/components/schemas/Charge` |
| 400 | バリデーションエラー | application/json | `#/components/schemas/Error` |
| 401 | 認証失敗 | application/json | `#/components/schemas/Error` |
| 402 | カード不正・決済失敗 | application/json | `#/components/schemas/Error` |
| 429 | レート制限超過 | application/json | `#/components/schemas/Error` |
| 500 | 内部サーバーエラー | application/json | `#/components/schemas/Error` |
| 503 | サービス一時停止 | application/json | `#/components/schemas/Error` |

**(Example Response 200)**
```json
{
  "id": "ch_123456",
  "amount": 1000,
  "status": "succeeded"
}
```

#### 2.1.4 SLA・可用性情報
* **稼働率**: 99.9% (決済代行会社の保証値)
* **メンテナンスウィンドウ**: 毎月第2日曜 AM 2:00-4:00
* **サポート窓口**: support@payment-gateway.com (24時間対応)
* **ステータスページ**: https://status.payment-gateway.com

#### 2.1.5 APIバージョニング・互換性
**バージョン管理**:
* 現在使用: v1
* 新バージョンリリース時: 6ヶ月間の並行運用期間
* 非推奨通知: 3ヶ月前にメール通知

**変更対応フロー**:
1. テスト環境で新バージョン検証
2. コード修正・テスト
3. Staging環境で統合テスト
4. 本番環境に段階的に展開 (Blue-Greenデプロイ)

---
### 2.2 [IF002] 売上データ連携
#### 2.2.1 概要
前日分の売上データをCSVファイルとして基幹システムへ送信する。

#### 2.2.2 ファイル仕様
* ファイル名: `sales_YYYYMMDD.csv`
* 文字コード: UTF-8 (BOMなし)
* 改行コード: LF
* 区切り文字: カンマ (`,`)

#### 2.2.3 レイアウト
| No | 項目名 | 型 | 桁数 | 必須 | 備考 |
| -- | -- | -- | -- | -- | -- |
| 1 | 売上日 | Date | 8 | 〇 | YYYYMMDD |
| 2 | 店舗コード | String | 10 | 〇 | |
| 3 | 売上金額 | Number | 10 | 〇 | |

#### 2.2.4 通信仕様
* プロトコル: SFTP
* 認証: 公開鍵認証
* 転送タイミング: 毎日 AM 4:00
* 転送先パス: `/upload/sales/`
* ファイル名ルール: `sales_YYYYMMDD.csv`

#### 2.2.5 整合性チェック
**ファイル検証**:
* **チェックサム**: MD5ハッシュを計算し、`.md5`ファイルとともに転送
  - 例: `sales_20260108.csv.md5`
* **件数突合**: ヘッダー行に `# Total Records: 1234` を追記
* **制御ファイル**: 転送完了後、`.done`ファイルを作成
  - 例: `sales_20260108.done`

#### 2.2.6 エラーハンドリング・リカバリ手順
**転送失敗時**:
1. 30分後に自動リトライ (最大3回)
2. 失敗通知: Slack #alerts + Email
3. エラーログ記録: CloudWatch Logs
4. 手動再送信スクリプト実行

**受信側エラー時**:
* 受信側からエラーファイルが `/error/` ディレクトリに配置される
* 日次バッチでエラーファイルをチェック・通知

**データ不整合時**:
* 件数不一致: アラート発生、手動確認
* チェックサム相違: ファイル破損とみなして再送信

---

## 3. モック・ストューブ環境
### 3.1 開発・テスト用モック環境
**決済APIモック**:
* **ツール**: Prism (OpenAPIスキーマから自動生成)
* **エンドポイント**: `http://localhost:4010`
* **テストデータ**: サンプルレスポンスを`mocks/payment-api.json`で管理

**ファイル転送モック**:
* ローカルSFTPサーバー構築 (Docker: atmoz/sftp)
* テスト用ディレクトリ: `/upload/sales-test/`

### 3.2 Staging環境
* 決済API: 決済代行会社提供のサンドボック環境を使用
* 基幹システム: テスト用SFTPサーバーへ転送

---

## 改訂履歴
| バージョン | 日付 | 変更内容 | 承認者 |
|------------|------|----------|--------|
| 1.0 | 2026-01-08 | 初版作成 | - |
