# 外部インターフェース設計書

## 0. ドキュメント情報
| 項目 | 内容 |
| -- | -- |
| システム名 | [System Name] |
| 対象範囲 | 外部連携IF全般 |
| バージョン | 1.0 |
| 作成日 | YYYY-MM-DD |
| 作成者 | [Name] |
| 承認者 | [Name] |

## 1. インターフェース一覧
| IF ID | 連携システム | 名称 | 方式 | プロトコル | 方向 | 頻度 | 重要度 |
| -- | -- | -- | -- | -- | -- | -- | -- |
| IF001 | 決済代行システム | 決済API | REST API | HTTPS | Out | 都度 | High |
| IF002 | 基幹システム | 売上データ連携 | ファイル転送 | SFTP | Out | 日次 | Medium |

## 2. 契約・変更管理
- **仕様の正**: OpenAPI v3.x または インターフェース定義書
- **バージョニング**: Major/Minor/Patch を明記
- **変更管理**: 影響範囲分析 → 互換性評価 → ロールアウト計画
- **契約テスト**: 仕様に基づく自動検証（CIで実行）

## 3. 共通セキュリティ・運用
- **認証情報管理**: Secrets Manager/KMSで管理、90日ごとにローテーション
- **IP制限**: 送信元IPをAllowlist化
- **mTLS**: 要件に応じて導入可否を記載
- **相関ID**: `X-Request-Id` を全リクエストに付与
- **ログマスキング**: PII/決済情報はマスキング
- **責務分界**: SLA、障害時の連絡先、復旧時間を明記

## 4. インターフェース詳細
### 4.0 OpenAPI仕様 (Swagger)
- **Define File**: `docs/openapi.yaml`
- **Viewer**: Swagger UI / Redoc
- **生成物**: SDK/MockはOpenAPIから生成し手修正禁止

### 4.1 [IF001] 決済API
#### 4.1.1 概要
ユーザーが商品を注文した際に、即時決済を行うためのAPI。

#### 4.1.2 接続情報
- **Base URL**: `https://api.payment-gateway.com`
- **Auth**: Bearer Token (OAuth 2.0)
- **Timeout**: 接続5秒 / 読み取り10秒
- **レート制限**: 100 req/min（変更時はWAF/アプリ側で調整）

#### 4.1.3 ヘッダー仕様
| ヘッダー | 必須 | 例 | 備考 |
| -- | -- | -- | -- |
| Authorization | Yes | `Bearer <token>` | 期限切れ時は再取得 |
| Idempotency-Key | Yes | UUID | 24時間以内は冪等 |
| X-Request-Id | Yes | UUID | 追跡用 |

#### 4.1.4 リトライポリシー
- **対象**: 5xx、ネットワークタイムアウト、429
- **回数**: 最大3回
- **バックオフ**: 1s → 2s → 4s（±20%ジッター）
- **対象外**: 4xx（バリデーション/認証）

#### 4.1.5 冪等性設計
- `Idempotency-Key` と `order_id` の組み合わせで重複排除
- 失敗時はローカル `payment_transactions` を `FAILED` に更新

#### 4.1.6 API定義（抜粋）
**Operation**: `POST /v1/charges`

**Request**:
| Name | In | Type | Required | Description |
| -- | -- | -- | -- | -- |
| amount | body | integer | Yes | 決済金額（最小単位） |
| currency | body | string | Yes | 通貨コード (jpy) |
| source | body | string | Yes | トークンID |

**Response**:
| Code | Description | Schema |
| -- | -- | -- |
| 200 | 決済成功 | `Charge` |
| 400 | バリデーションエラー | `Error` |
| 401 | 認証失敗 | `Error` |
| 402 | 決済失敗 | `Error` |
| 429 | レート制限 | `Error` |
| 5xx | サーバー障害 | `Error` |

**Error Schema (共通)**:
```json
{
  "error": {
    "code": "PAYMENT_FAILED",
    "message": "...",
    "request_id": "req_xxx"
  }
}
```

#### 4.1.7 SLA・可用性情報
- **稼働率**: 99.9%
- **メンテナンス**: 毎月第2日曜 AM 2:00-4:00
- **サポート窓口**: support@payment-gateway.com

#### 4.1.8 監視・運用
- 失敗率・レイテンシのSLOを定義
- 障害発生時の切り戻し手順を明記

---
### 4.2 [IF002] 売上データ連携
#### 4.2.1 概要
前日分の売上データをCSVファイルとして基幹システムへ送信する。

#### 4.2.2 ファイル仕様
- **ファイル名**: `sales_YYYYMMDD.csv`
- **文字コード**: UTF-8 (BOMなし)
- **改行コード**: LF
- **区切り文字**: カンマ
- **小数精度**: 2桁固定
- **タイムゾーン**: JST

#### 4.2.3 レイアウト
| No | 項目名 | 型 | 桁数 | 必須 | 備考 |
| -- | -- | -- | -- | -- | -- |
| 1 | 売上日 | Date | 8 | 〇 | YYYYMMDD |
| 2 | 店舗コード | String | 10 | 〇 | 0埋め |
| 3 | 売上金額 | Number | 10 | 〇 | 小数2桁 |

#### 4.2.4 ファイル整合性
- **チェックサム**: SHA-256（`.sha256` 同送）
- **件数突合**: ヘッダーに `# Total Records` を付与
- **制御ファイル**: `.done` で完了を通知

#### 4.2.5 通信仕様
- **プロトコル**: SFTP
- **認証**: 公開鍵認証
- **転送タイミング**: 毎日 AM 4:00
- **転送先パス**: `/upload/sales/`

#### 4.2.6 エラーハンドリング
- 30分後に自動リトライ（最大3回）
- 失敗通知: Slack #alerts + Email
- 手動再送スクリプトを用意

---

## 5. モック・スタブ環境
### 5.1 開発・テスト用モック
- **決済APIモック**: Prism (OpenAPIから生成)
- **エンドポイント**: `http://localhost:4010`
- **テストデータ**: `mocks/payment-api.json`

### 5.2 Staging環境
- 決済APIはサンドボックス利用
- SFTPはテスト用サーバーへ転送

---

## 改訂履歴
| バージョン | 日付 | 変更内容 | 承認者 |
| -- | -- | -- | -- |
| 1.0 | 2026-01-08 | 初版作成 | - |
