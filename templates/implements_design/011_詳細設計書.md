# 詳細設計書

## 0. ドキュメント情報
| 項目 | 内容 |
| -- | -- |
| システム名 | [System Name] |
| 対象範囲 | [モジュール一覧] |
| バージョン | 1.0 |
| 作成日 | YYYY-MM-DD |
| 作成者 | [Name] |
| 承認者 | [Name] |

## 1. 設計方針
- **言語/実装方針**: Go に合わせたパッケージ構成とエラーハンドリング
- **依存方向**: Controller → Service → Repository / Gateway
- **エラー**: `error` を返す設計（例外前提の設計は採用しない）
- **トランザクション**: `context.Context` と明示的な `Tx` を使用

## 2. モジュール一覧
| モジュールID | 名称 | 概要 | 責任 | 担当 |
| -- | -- | -- | -- | -- |
| M001 | OrderService | 注文処理ロジック | 注文の作成・更新・検証 | サーバー |
| M002 | PaymentGateway | 決済連携アダプタ | 外部決済APIとの通信 | サーバー |
| M003 | InventoryService | 在庫管理サービス | 在庫の確認・引き当て・解放 | サーバー |
| M004 | UserAuthService | ユーザー認証サービス | ログイン・JWT発行 | サーバー |
| M005 | EmailNotificationService | メール通知サービス | 非同期メール送信 | サーバー |
| M006 | CacheManager | キャッシュ管理 | Redisキャッシュの読み書き | サーバー |

## 3. 詳細設計
### 3.1 [M001] OrderService
#### 3.1.1 パッケージ/構造
- **Package**: `internal/service`
- **Struct**: `OrderService`

**Dependencies (DI)**:
- `OrderRepository`
- `InventoryService`
- `PaymentGateway`
- `EmailNotificationService`
- `Logger`

#### 3.1.2 メソッド定義
| 返り値 | メソッド名 | 引数 | 概要 |
| -- | -- | -- | -- |
| `(*Order, error)` | `CreateOrder` | `ctx, req` | 注文作成 |
| `(*Order, error)` | `GetOrder` | `ctx, orderID, userID` | 注文取得 |
| `error` | `CancelOrder` | `ctx, orderID, userID` | 注文キャンセル |

#### 3.1.3 データ型定義
```go
type OrderRequest struct {
    UserID          int             `json:"user_id" validate:"required,min=1"`
    Items           []OrderItem     `json:"items" validate:"required,min=1,dive"`
    ShippingAddress ShippingAddress `json:"shipping_address" validate:"required"`
    PaymentMethod   string          `json:"payment_method" validate:"required,oneof=credit_card bank_transfer"`
}

type OrderItem struct {
    ProductID int `json:"product_id" validate:"required,min=1"`
    Quantity  int `json:"quantity" validate:"required,min=1,max=99"`
}
```

#### 3.1.4 処理ロジック (CreateOrder)
**トランザクション境界**: メソッド全体を `Tx` で囲む

1. **入力バリデーション**: リクエスト検証、`ErrInvalidRequest` を返却
2. **在庫確保**: `InventoryService.Reserve(ctx, tx, productID, qty)`
3. **注文保存**: `OrderRepository.Create(ctx, tx, order)`
4. **決済処理**: `PaymentGateway.Charge(ctx, orderID, amount)`
5. **ステータス更新**: 成功時 `CONFIRMED`、失敗時 `FAILED`
6. **メール送信**: 非同期キューへ投入（失敗してもTxはロールバックしない）

#### 3.1.5 エラー設計
**エラー分類**:
- `ErrInvalidRequest` → 400
- `ErrOutOfStock` → 422
- `ErrPaymentFailed` → 402
- `ErrNotFound` → 404
- `ErrUnauthorized` → 403
- `ErrInternal` → 500

#### 3.1.6 排他制御
- `products.version` による楽観ロック
- 更新SQLで `WHERE id = ? AND version = ?` を使用

#### 3.1.7 テスト観点
- 正常系、異常系、外部API失敗時のロールバック
- 同時実行時の在庫競合

---
### 3.2 [M002] PaymentGateway
#### 3.2.1 インターフェース
```go
type PaymentGateway interface {
    Charge(ctx context.Context, orderID int, amount float64, method string) error
}
```

#### 3.2.2 実装方針
- リトライ/サーキットブレーカーは共通ミドルウェアで適用
- `Idempotency-Key` を必ず付与

---
### 3.3 [M003] InventoryService
#### 3.3.1 メソッド
| 返り値 | メソッド名 | 引数 | 概要 |
| -- | -- | -- | -- |
| `error` | `Reserve` | `ctx, tx, productID, qty` | 在庫確保 |
| `error` | `Release` | `ctx, tx, productID, qty` | 在庫解放 |

---
### 3.4 [M004] UserAuthService
- JWT発行/検証
- セッション管理はRedis

---
### 3.5 [M005] EmailNotificationService
- キューイング後に非同期送信
- 送信失敗はリトライ（最大3回）

---
### 3.6 [M006] CacheManager
- Cache-Aside を標準
- TTL/無効化条件を明記

## 4. キャッシュ戦略
| データ種別 | キー形式 | TTL | 無効化タイミング |
| -- | -- | -- | -- |
| 商品情報 | `product:{id}` | 1時間 | 商品更新時 |
| 在庫情報 | `stock:{product_id}` | 30秒 | 在庫変更時 |
| ユーザーセッション | `session:{user_id}` | 24時間 | ログアウト時 |
| カテゴリ一覧 | `categories:all` | 12時間 | カテゴリ追加時 |

### 4.1 キャッシュスタンピード対策
- 人気商品のプリロード
- 新バージョンデプロイ前のキャッシュウォーミング

## 5. 依存性注入 (DI) 設計
**フレームワーク**: Wire
- Provider Set に Repository/Service/Gateway を登録
- リクエストスコープは採用せず、Handler はステートレス

---

## 改訂履歴
| バージョン | 日付 | 変更内容 | 承認者 |
| -- | -- | -- | -- |
| 1.0 | 2026-01-08 | 初版作成 | - |
